
<p>This quickstart will get you going with a Spring MVC Hibernate application that uses a Postgres database service, deployed to Heroku. For general information on how to develop and architect apps for use on Heroku, see <a href="https://devcenter.heroku.com/articles/architecting-apps">Architecting Applications for Heroku</a>.</p>
<div class="note">

<p>If you have questions about Java on Heroku, consider discussing them in the <a href="https://discussion.heroku.com/category/java">Java on Heroku forums</a>.</p>

</div>
<p class="callout">Sample code for the <a href="https://github.com/heroku/devcenter-spring-mvc-hibernate">demo application</a> is available on GitHub. Edits and enhancements are welcome. Just fork the repository, make your changes and send us a pull request.</p>

<h2 id="prerequisites">Prerequisites</h2>

<ul>
<li>Java, Maven, Git, and the Heroku client (as described in the <a href="https://devcenter.heroku.com/articles/java">basic Java quickstart</a>)</li>

<li>An installed version of <a href="http://www.postgresql.org/">Postgres</a> to test locally</li>

<li>A Heroku user account. <a href="https://api.heroku.com/signup/devcenter">Signup is free and instant</a>.</li>
</ul><h2 id="create-a-java-app-that-uses-spring-mvc-and-hibernate">Create a Java app that uses Spring MVC and Hibernate</h2>

<p>If you don’t already have a Spring MVC Hibernate app, the easiest way to create one is with Spring Roo. Spring Roo is a RAD tool that lets you quickly build Spring MVC applications with a complete model, view and controller layer, including relational database integration.</p>

<h3 id="option-1-clone-the-sample-app">Option 1. Clone the sample app</h3>

<p>If you don’t want to install Spring Roo, you can clone the sample app:</p>

<pre><code class="term">$ git clone https://github.com/heroku/devcenter-spring-mvc-hibernate.git
Cloning into petclinic...
remote: Counting objects: 205, done.
remote: Compressing objects: 100% (100/100), done.
remote: Total 205 (delta 93), reused 205 (delta 93)
Receiving objects: 100% (205/205), 98.55 KiB, done.
Resolving deltas: 100% (93/93), done.</code></pre>

<p>This will check out the completed app. To step back to the starting point, do:</p>

<pre><code class="term">$ git revert starting-point</code></pre>

<p>Now you can skip forward to “Modify Database Configuration”.</p>

<h3 id="option-2-create-the-app-using-spring-roo">Option 2. Create the app using Spring Roo</h3>

<p><a href="http://www.springsource.com/download/community?project=Spring%20Roo">Install Spring Roo</a> if you don’t already have it. Then create a directory for your app and generate the app using the <code>clinic.roo</code> script:</p>

<pre><code class="term">$ mkdir petclinic &amp;&amp; cd petclinic
$ roo script --file clinic.roo</code></pre>
<hr><pre><code>   / __ \/ __ \/ __ \
  / /_/ / / / / / / /
 / _, _/ /_/ / /_/ /
/_/ |_|\____/\____/    1.1.4.RELEASE [rev f787ce7]


Welcome to Spring Roo. For assistance press TAB or type "hint" then hit ENTER.
project --topLevelPackage com.springsource.petclinic
Created ROOT/pom.xml
Created SRC_MAIN_JAVA
Created SRC_MAIN_RESOURCES
...
Updated SRC_MAIN_RESOURCES/log4j.properties
Script required 41 second(s) to execute</code></pre>

<p>By default, the generated app sets up the Hypersonic in-memory database. However, it is strongly recommended to use the same database locally as in production. So we will switch the application over to using Postgres with this Roo command:</p>

<pre><code class="term">$ roo persistence setup --provider HIBERNATE --database POSTGRES
...
Updated SRC_MAIN_RESOURCES/META-INF/spring/database.properties
Please update your database details in src/main/resources/META-INF/spring/database.properties.
Updated ROOT/pom.xml [removed dependency org.hsqldb:hsqldb:1.8.0.10; added dependency postgresql:postgresql:8.4-702.jdbc3]
Updated SRC_MAIN_RESOURCES/META-INF/spring/applicationContext.xml
Updated SRC_MAIN_RESOURCES/META-INF/persistence.xml
...</code></pre>

<p>Finally, let’s create a git repo and commit this baseline of our application:</p>

<pre><code class="term">$ git init
$ echo target &gt; .gitignore
$ git add .
$ git commit -m init</code></pre>

<h2 id="modify-database-configuration">Modify database configuration</h2>

<p>The web app generated by Spring Roo expects you to set database connection properties in the file <code>src/main/resources/META-INF/spring/database.properties</code>. However, it is not a good idea to hardcode database configuration into a file that is part of your project. Instead, we will edit the Spring configuration to read the configuration from an environment variable.</p>

<p>Heroku automatically provisions a <a href="https://devcenter.heroku.com/articles/heroku-postgres-starter-tier">small database</a> when you create a Java application and sets the <code>DATABASE_URL</code> environment variable to a URL of the format</p>

<pre><code>postgres://user:password@hostname:port/dbname</code></pre>

<p>You can also provision a larger database service yourself using the <code>heroku addons</code> command. Either way, the database connection information will be stored in the <code>DATABASE_URL</code> variable.</p>

<p>Create a new URI spring bean initialized with this environment variable by adding this to <code>src/main/resources/META-INF/spring/applicationContext.xml</code>:</p>

<pre><code class="xml">&lt;bean class="java.net.URI" id="dbUrl"&gt;
    &lt;constructor-arg value="${DATABASE_URL}"/&gt;
&lt;/bean&gt;</code></pre>

<p>Edit the <code>dataSource</code> section in <code>src/main/resources/META-INF/spring/applicationContext.xml</code> and replace the property place holders with the following:</p>

<pre><code class="xml">&lt;bean class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close" id="dataSource"&gt;
    &lt;property name="driverClassName" value="${database.driverClassName}"/&gt;
    &lt;property name="url" value="#{ 'jdbc:postgresql://' + @dbUrl.getHost() + ':' + @dbUrl.getPort() + @dbUrl.getPath() }"/&gt;
    &lt;property name="username" value="#{ @dbUrl.getUserInfo().split(':')[0] }"/&gt;
    &lt;property name="password" value="#{ @dbUrl.getUserInfo().split(':')[1] }"/&gt;
    ...</code></pre>

<p>To run your app locally set the DATABASE_URL variable in your local environment to point to your local postgres database, for example:</p>

<pre><code class="term">$ export DATABASE_URL=postgres://scott:tiger@localhost:5432/myapp</code></pre>

<h2 id="add-jetty-runner">Add Jetty Runner</h2>

<p>Jetty Runner lets you easily execute your web app as a standard Java application (without having to deploy it to a container). It’s a simple jar that you can copy down from the central Maven repository to the target directory as part of you build. We’ll use the <code>maven-dependency-plugin</code> to do this by adding the following plugin configuration at the end of the <code>plugins</code> section of <code>pom.xml</code>:</p>

<pre><code class="xml">&lt;plugin&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
    &lt;version&gt;2.3&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;phase&gt;package&lt;/phase&gt;
            &lt;goals&gt;&lt;goal&gt;copy&lt;/goal&gt;&lt;/goals&gt;
            &lt;configuration&gt;
                &lt;artifactItems&gt;
                    &lt;artifactItem&gt;
                        &lt;groupId&gt;org.mortbay.jetty&lt;/groupId&gt;
                        &lt;artifactId&gt;jetty-runner&lt;/artifactId&gt;
                        &lt;version&gt;7.4.5.v20110725&lt;/version&gt;
                        &lt;destFileName&gt;jetty-runner.jar&lt;/destFileName&gt;
                    &lt;/artifactItem&gt;
                &lt;/artifactItems&gt;
            &lt;/configuration&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>

<h2 id="declare-process-types-with-procfile">Declare process types with Procfile</h2>

<p>Use a <a href="https://devcenter.heroku.com/articles/procfile">Procfile</a>, a text file in the root directory of your application, to explicitly declare what command should be executed to start a web <a href="https://devcenter.heroku.com/articles/dynos">dyno</a>. In this case, you want to execute the Jetty Runner.</p>

<p>Here’s a <code>Procfile</code> for the sample app we’ve been working on:</p>

<pre><code class="term">web: java $JAVA_OPTS -jar target/dependency/jetty-runner.jar --port $PORT target/*.war</code></pre>

<p>This declares a single process type, <code>web</code>, and the command needed to run it. The name “web” is important here. It declares that this process type will be attached to the <a href="https://devcenter.heroku.com/articles/http-routing">HTTP routing</a> stack of Heroku, and receive web traffic when deployed.</p>

<h2 id="optionally-choose-a-jdk">Optionally Choose a JDK</h2>

<p>By default, OpenJDK 1.6 is installed with your app. However, you can choose to use a newer JDK by specifying <code>java.runtime.version=1.7</code> in the <code>system.properties</code> file.</p>

<p>Here’s what a <code>system.properties</code> file looks like:</p>

<pre><code class="term">java.runtime.version=1.7</code></pre>

<p>You can specify 1.6, 1.7, or 1.8 (1.8 is in beta) for Java 6, 7, or 8 (with lambdas), respectively.</p>

<h2 id="run-your-app-locally">Run your app locally</h2>

<p>Let’s run the app locally first to test that it all works. You must have a Postgres database up and running and accessible on the <code>DATABASE_URL</code> you specified above.</p>

<h3 id="build-your-app">Build your app</h3>

<pre><code class="term">$ mvn package
[INFO] Scanning for projects...
[INFO]
[INFO] ------------------------------------------------------------------------
[INFO] Building petclinic 0.1.0.BUILD-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO]
...
[INFO] --- maven-dependency-plugin:2.3:copy (default) @ petclinic ---
[INFO] Configured Artifact: org.mortbay.jetty:jetty-runner:7.4.5.v20110725:jar
[INFO] Copying jetty-runner-7.4.5.v20110725.jar to /Users/jjoergensen/dev/tmp/spring-roo-petclinic/target/dependency/jetty-runner.jar
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 20.466s
[INFO] Finished at: Mon Aug 29 20:56:03 PDT 2011
[INFO] Final Memory: 9M/81M
[INFO] ------------------------------------------------------------------------</code></pre>

<h3 id="start-your-app">Start your app</h3>
<div class="callout">

<p>Note: you can also start your app using foreman to execute the Procfile. <a href="https://devcenter.heroku.com/articles/procfile">Read more about foreman and Procfiles</a>.</p>

</div>
<pre><code class="term">$ java -jar target/dependency/jetty-runner.jar target/*.war</code></pre>

<h3 id="test-it">Test it</h3>

<p>Go to <a href="http://localhost:8080">http://localhost:8080</a> and test it out by creating a new record.</p>

<h2 id="store-your-app-in-git">Store your app in Git</h2>

<p>We now have the application with it’s dependencies declared in <code>pom.xml</code>, and a Procfile. Let’s put it into Git:</p>

<pre><code class="term">$ git add .
$ git commit -m "Ready to deploy"</code></pre>

<h2 id="deploy-your-application-to-heroku">Deploy your application to Heroku</h2>

<p>Create the app:</p>

<pre><code class="term">$ heroku create
Creating high-lightning-129... done, stack is cedar
http://high-lightning-129.herokuapp.com/ | git@heroku.com:high-lightning-129.git
Git remote heroku added</code></pre>

<p>Deploy your code:</p>

<pre><code class="term">$ git push heroku master
Counting objects: 227, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (117/117), done.
Writing objects: 100% (227/227), 101.06 KiB, done.
Total 227 (delta 99), reused 220 (delta 98)

-----&gt; Heroku receiving push
-----&gt; Java app detected
-----&gt; Installing Maven 3.0.3..... done
-----&gt; Installing settings.xml..... done
-----&gt; executing .maven/bin/mvn -B -Duser.home=/tmp/build_1jems2so86ck4 -s .m2/settings.xml -DskipTests=true clean install
       [INFO] Scanning for projects...
       [INFO]
       [INFO] ------------------------------------------------------------------------
       [INFO] Building petclinic 0.1.0.BUILD-SNAPSHOT
       [INFO] ------------------------------------------------------------------------
       ...
       [INFO] ------------------------------------------------------------------------
       [INFO] BUILD SUCCESS
       [INFO] ------------------------------------------------------------------------
       [INFO] Total time: 36.612s
       [INFO] Finished at: Tue Aug 30 04:03:02 UTC 2011
       [INFO] Final Memory: 19M/287M
       [INFO] ------------------------------------------------------------------------
-----&gt; Discovering process types
       Procfile declares types -&gt; web
-----&gt; Compiled slug size is 62.7MB
-----&gt; Launching... done, v5
       http://pure-window-800.herokuapp.com deployed to Heroku</code></pre>

<p>Congratulations! Your web app should now be up and running on Heroku.</p>

<h2 id="visit-your-application">Visit your application</h2>

<p>You’ve deployed your code to Heroku, and specified the process types in a <code>Procfile</code>. You can now instruct Heroku to execute a process type. Heroku does this by running the associated command in a <a href="https://devcenter.heroku.com/articles/dynos">dyno</a> - a lightweight container which is the basic unit of composition on Heroku.</p>

<p>Let’s ensure we have one dyno running the <code>web</code> process type:</p>

<pre><code class="term">$ heroku ps:scale web=1</code></pre>

<p>You can check the state of the app’s dynos. The <code>heroku ps</code> command lists the running dynos of your application:</p>

<pre><code class="term">$ heroku ps
=== web: `java $JAVA_OPTS -jar target/dependency/jetty-runner.jar --port $PORT target/*.war`
web.1: up for 6m</code></pre>

<p>Here, one dyno is running.</p>

<p>We can now visit the app in our browser with <code>heroku open</code>.</p>

<pre><code class="term">$ heroku open
Opening pure-window-800... done</code></pre>

<h2 id="dyno-sleeping-and-scaling">Dyno sleeping and scaling</h2>

<p>Having only a single web dyno running will result in the dyno <a href="https://devcenter.heroku.com/articles/dynos#dyno-sleeping">going to sleep</a> after one hour of inactivity. This causes a delay of a few seconds for the first request upon waking. Subsequent requests will perform normally.</p>

<p>To avoid this, you can scale to more than one web dyno. For example:</p>

<pre><code class="term">$ heroku ps:scale web=2</code></pre>

<p>For each application, Heroku provides <a href="https://devcenter.heroku.com/articles/usage-and-billing#750-free-dyno-hours-per-app">750 free dyno-hours</a>. Running your app at 2 dynos would exceed this free, monthly allowance, so let’s scale back:</p>

<pre><code class="term">$ heroku ps:scale web=1</code></pre>

<h2 id="view-the-logs">View the logs</h2>

<p>Heroku treats logs as streams of time-ordered events aggregated from the output streams of all the dynos running the components of your application. Heroku’s <a href="https://devcenter.heroku.com/articles/logplex">Logplex</a> provides a single channel for all of these events.</p>

<p>View information about your running app using one of the <a href="https://devcenter.heroku.com/articles/logging">logging commands</a>, <code>heroku logs</code>:</p>

<pre><code class="term">$ heroku logs
...
2012-09-11T19:12:27+00:00 app[web.1]: 2012-09-11 19:12:27,217 [main] INFO org.springframework.web.servlet.DispatcherServlet - FrameworkServlet 'petclinic': initialization completed in 573 ms
2012-09-11T19:12:27+00:00 app[web.1]: 2012-09-11 19:12:27.240:INFO::Started SelectChannelConnector@0.0.0.0:38895 STARTING
2012-09-11T19:12:28+00:00 heroku[web.1]: State changed from starting to up</code></pre>

<h2 id="next-steps">Next steps</h2>

<ul>
<li>Visit the <a href="https://devcenter.heroku.com/categories/java">Java category</a> to learn more about developing and deploying Java applications.</li>

<li>Read <a href="https://devcenter.heroku.com/articles/how-heroku-works">How Heroku Works</a> for a technical overview of the concepts you’ll encounter while writing, configuring, deploying and running applications.</li>
</ul>