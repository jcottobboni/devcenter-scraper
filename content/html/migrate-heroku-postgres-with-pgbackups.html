
<p>Often times it is necessary to transfer the contents of one application’s database to another application. For instance, when maintaining both a staging and production environment of a single application you may wish to take a snapshot of the production data and import it to staging for testing purposes.</p>

<p>The <a href="https://addons.heroku.com/pgbackups">PG Backups add-on</a> is useful not only for capturing regular backups of your database but also as a data migration tool across applications. This assumes you have the PG Backups add-on already installed on both applications involved in the transfer.</p>
<p class="note">
Transferring data between databases <em>of the same application</em> as part of a database upgrade is also well-supported. See <a href="https://devcenter.heroku.com/articles/upgrade-heroku-postgres-with-pgbackups">upgrading starter tier databases with PG Backups</a> or <a href="https://devcenter.heroku.com/articles/heroku-postgres-follower-databases#database-upgrades-and-migrations-with-changeovers">upgrading production databases using followers</a>.
</p>
<p>For the purpose of consistency the database being migrated <em>from</em> will be called the source database while the database being migrated <em>to</em> will be called the target database.</p>
<p class="warning">Migration for large databases (with a dump size of more than about 5GB) are not supported using this mechanism at this time. The breaking point is when <code>heroku
pgbackups:url -a source-app</code> produces more than one URL for your backup. For production databases, you can <a href="https://devcenter.heroku.com/articles/heroku-postgres-fork">create a fork</a> across applications instead by using the full URL of the source database.</p>
<h2 id="capture-source-snapshot">Capture source snapshot</h2>

<p>The first step is to capture a snapshot of the source database using <code>heroku pgbackups</code>.</p>
<p class="callout">
The <code>--expire</code> flag tells pgbackups to automatically expire the oldest manual backup if the retention limit is reached.
</p>
<pre><code class="term">$ heroku pgbackups:capture -a source-app --expire

DATABASE_URL  ----backup---&gt;  b001

Capturing... done
Storing... done</code></pre>

<h2 id="create-target-backup">Create target backup</h2>

<p>To ensure that you can easily revert the target database back to its state before the transfer it’s recommended that you make a backup.</p>

<pre><code class="term">$ heroku pgbackups:capture -a target-app --expire</code></pre>

<p>If you need to revert the target database back because of a botched transfer or other mistake you can do so with:</p>

<pre><code class="term">$ heroku pgbackups:restore HEROKU_POSTGRESQL_TURQUOISE -a target-app</code></pre>

<h2 id="transfer-to-target-database">Transfer to target database</h2>

<p>To restore the source database snapshot to the target database you will need to invoke <code>pgbackups</code> from the target application, referencing the recent snapshot URL of the source database. This is a destructive operation: the restore operation will drop existing data and replace it with the contents of the backup. The contents of the database prior to a restore will not be recoverable.</p>
<p class="warning">
Pay special attention to the <code>-a app-name</code> flags as they specify the source and target destinations and can be mistakenly transposed.
</p>
<pre><code class="term">$ heroku pgbackups:restore HEROKU_POSTGRESQL_TURQUOISE -a target-app \
    `heroku pgbackups:url -a source-app`</code></pre>

<p>This command tells PG Backups to restore the most recent backup of <code>source-app</code> <em>to</em> the database located at <code>HEROKU_POSTGRESQL_TURQUOISE</code> where the color is the specific color of your database on the <code>target-app</code> application.</p>

<p>Depending on the size of the dataset being migrated both the capture and restore steps can take some time. See the <a href="https://devcenter.heroku.com/articles/pgbackups">PG Backups add-on docs</a> for more detailed description of the various <code>pgbackup</code> commands.</p>