<!--

Please make edits and comments on https://draftin.com/documents/264544?token=rqM27KdROTS790ERzxvu7wxTu5hf4qiycyB3feOTVMuaoH-gMWE3fMiXPrO6mARxjay-D2wDglOsxjZKMHlsJWs

-->

<p>The asset pipeline was introduced into Rails in version 3.1. This article contains information needed to run the asset pipeline in Rails version 4 and above on Heroku.
This guide is <strong>not</strong> comprehensive, please see <a href="https://devcenter.heroku.com/articles/rails-asset-pipeline">the Rails Asset Pipeline on Heroku Cedar</a> for help with debugging and troubleshooting. This article adds additional information that is specific to the behavior in Rails 4.</p>

<h2 id="serve-assets">Serve assets</h2>

<p>By default Rails 4 will not serve your assets. To enable this functionality you need to go into <code>config/application.rb</code> and add this line:</p>

<pre><code class="ruby">config.serve_static_assets = true
</code></pre>

<p>Alternatively you can achieve the same result by including the <a href="https://github.com/heroku/rails_12factor">rails_12factor</a> gem in your Gemfile:</p>

<pre><code class="ruby">gem 'rails_12factor', group: :production
</code></pre>

<p>This gem will <a href="https://github.com/heroku/rails_12factor#rails-4-serve-static-assets">configure your application to serve static assets</a> so that you do not need to do this manually in a config file.</p>

<h2 id="only-generate-digest-assets">Only generate digest assets</h2>

<p>In Rails 3, the version of sprockets used in the asset pipeline would produce a “digest” or a <a href="http://guides.rubyonrails.org/asset_pipeline.html#what-is-fingerprinting-and-why-should-i-care-questionmark">“fingerprint”</a> for an asset and then attach it to it’s file name. For example this file:</p>

<pre><code>app/assets/stylesheets/application.css.erb
</code></pre>

<p>When precompiled would become:</p>

<pre><code>public/assets/application-c655834251f73d7714351aa287be8556.css
</code></pre>

<p>Where “c655834251f73d7714351aa287be8556” is the “digest” or “fingerprint” generated by MD5. In addition to “digest” file names Rails 3 asset pipeline would produce a non-digest version <code>public/assets/application.css</code>. This was useful for things like sending out emails where the recipient may or may not download the asset in a timely manner.</p>

<p>In Rails 4 sprockets will only produce digest filenames. This means that you must use an ERB helper such as this to reference your assets:</p>

<pre><code>&lt;%= asset_path('logo.png') %&gt;
</code></pre>

<p>Make sure to add a <code>.erb</code> extension to any files in <code>app/assets</code> that use an ERB helper. So <code>application.css</code> would need to be <code>application.css.erb</code>.</p>

<p>To get around the “email problem”, sprockets will now keep up to 3 copies of the same modified asset at a time. This also helps with rolling deploys so requests for older assets are still available. Even with this behavior it is recommend you <a href="https://devcenter.heroku.com/articles/using-amazon-cloudfront-cdn">use a CDN to serve your assets</a>.</p>

<h2 id="caching">Caching</h2>

<p>Heroku now caches 50mb worth of <code>tmp/cache/assets</code> which is a cache directory for the asset pipeline to store intermediate files. This means that future asset compilations will be faster due to not having to recalculate these files.</p>

<p>This is a difference in Heroku and not in the Rails framework. Rails 3 assets are generated on every deploy as there are several bugs that prevent caching from being used effectively.</p>

<h2 id="debug-output">Debug output</h2>

<p>When <code>$ rake assets:precompile</code> is run in production Rails 4 will now shows debug output while generating tmp files, this does not mean your files end up in <code>/tmp</code>. The files will be copied to their correct locations after they are generated.</p>

<h2 id="known-issues">Known issues</h2>

<p>There are two known issues with Rails 4 (sprockets) that can be difficult to detect or debug. To help with this we recommend using the <a href="https://github.com/schneems/sprockets_better_errors"> sprockets better errors gem</a> gem in production. These checks have been merged into Rails 4.1+ but the gem is still needed for 4.0.x versions.</p>

<h3 id="dependencies-improperly-used">Dependencies improperly used</h3>

<p>You can see a failure in sprockets When you change an asset file that is referenced in another file and the reference does not change. This is due to <a href="https://github.com/schneems/sprockets_better_errors#raise-when-dependencies-improperly-used">missing sprockets dependency declarations</a>.</p>

<p>For example you can have a CSS file <code>app/assets/stylesheets/application.css.erb</code> that references another file:</p>

<pre><code class="css">.logo {
  background-image:url('&lt;%= asset_path("logo.png") %&gt; ');
}
</code></pre>

<p>Here <code>application.css.erb</code> relies on <code>app/assets/images/logo.png</code>. When precompile is run both assets will be generated. What happens if the <code>logo.png</code> is resized to be larger per a client request? The next time precompile runs, sprockets will see that <code>logo.png</code> has changed since it’s <a href="http://guides.rubyonrails.org/asset_pipeline.html#what-is-fingerprinting-and-why-should-i-care-questionmark">MD5 fingerprint</a> is now different so it will be compiled. Our <code>application.css.erb</code> however has not changed, so it will not be compiled again. This means our stylesheet now points to the wrong copy of our image. To fix this add an asset declaration to the top of your <code>application.css.erb</code> file:</p>

<pre><code class="css">//= depend_on_asset "logo.png"

.logo {
  background-image:url('&lt;%= asset_path("logo.png") %&gt; ');
}
</code></pre>

<p>Now when your <code>logo.png</code> changes, your <code>application.css.erb</code> will be required to compile again.</p>

<h3 id="missing-asset-in-precompile-list">Missing Asset in precompile list</h3>

<p>Another common production failure in sprockets is caused by assets not being declared as needing to be precompiled. By default all “application” assets and images are precompiled. This includes <code>application.css</code> and <code>application.js</code>. It is assumed that any CSS or JS in your project will be rolled into these files and so any extra JS or CSS in your project will not be precompiled. The gem <code>sprockets_better_errors</code> will <a href="https://github.com/schneems/sprockets_better_errors#raise-on-dev-asset-not-in-precompile-list">check for missing assets in your precompile list in development</a>.</p>

<h2 id="debugging">Debugging</h2>

<p>One of the best tools to debug your generated assets is to view them on your dynos:</p>

<pre><code>$ heroku run bash
$ ls public/assets
</code></pre>

<p>You should see a manifest-<code>&lt;digest&gt;.json</code> where <code>&lt;digest&gt;</code> is a long alphanumeric string as well as all of your asset files.</p>

<p>You can also see the exact file name that Rails believes it should serve by running <code>$ heroku run rails console</code>. In the console you can use the <code>helper</code> object and <code>asset_path</code> to determine the full path.</p>

<pre><code>$ heroku run rails console
&gt; puts helper.asset_path("application.js")
/assets/application-6aae32862efc758cf08c7b7fc0e85e15.js
</code></pre>

<h2 id="additional-troubleshooting">Additional troubleshooting</h2>

<p>Please see a comprehensive list in the <a href="https://devcenter.heroku.com/articles/rails-asset-pipeline#troubleshooting">Asset Pipeline troubleshooting section</a>.</p>