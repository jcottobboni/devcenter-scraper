<p>Ruby on Rails is a popular web framework written in <a href="http://www.ruby-lang.org/">Ruby</a>. For running previous versions of Rails on Heroku see <a href="https://devcenter.heroku.com/articles/rails3">Getting Started with Rails 3.x on Heroku</a>.</p>

<p>This article provides an in-depth getting started guide for Rails 4. If you are already familiar with Heroku and Rails, reference the <a href="https://devcenter.heroku.com/articles/rails4">simplifed Rails 4 on Heroku guide</a> instead. For general information on how to develop and architect apps for use on Heroku, see <a href="https://devcenter.heroku.com/articles/architecting-apps">Architecting Applications for Heroku</a>.</p>

<p>For this guide you will need:</p>

<ul>
<li>
<p>Basic Ruby/Rails knowledge, including an installed version of Ruby 2.0.0, Rubygems, Bundler, and Rails 4.</p>
</li>

<li>
<p>Basic Git knowledge</p>
</li>

<li>
<p>Your application must run on Ruby (MRI) 2.0.0.</p>
</li>

<li>
<p>A Heroku user account. <a href="https://api.heroku.com/signup/devcenter">Signup is free and instant</a>.</p>
</li>
</ul><h2 id="local-workstation-setup">Local workstation setup</h2>

<p>Install the <a href="https://toolbelt.heroku.com/">Heroku Toolbelt</a> on your local workstation. This ensures that you have access to the <a href="/categories/command-line">Heroku command-line client</a>, Foreman, and the Git revision control system. You will also need <a href="http://guides.railsgirls.com/install/">Ruby and Rails installed</a>.</p>

<p>Once installed, you’ll have access to the <code>heroku</code> command from your command shell. Log in using the email address and password you used when creating your Heroku account:</p>
<div class="callout">
<p>Note that <code>$</code> before commands indicates they should be run on the command line, prompt, or terminal with appropriate permissions.</p>
</div>
<pre><code class="term">$ heroku login
Enter your Heroku credentials.
Email: adam@example.com
Password:
Could not find an existing public key.
Would you like to generate one? [Yn]
Generating new SSH public key.
Uploading ssh public key /Users/adam/.ssh/id_rsa.pub</code></pre>

<p>Press enter at the prompt to upload your existing <code>ssh</code> key or create a new one, used for pushing code later on.</p>

<h2 id="write-your-app">Write your app</h2>

<p>You may be starting from an existing app, if so <a href="http://edgeguides.rubyonrails.org/upgrading_ruby_on_rails.html#upgrading-from-rails-3-2-to-rails-4-0">upgrade to Rails 4</a> before continuing. If not, a vanilla Rails 4 app will serve as a suitable sample app. To build a new app make sure that you’re using the Rails 4.x using <code>$ rails -v</code>. You can get the new version of rails by running,</p>

<pre><code class="term">$ gem install rails --version 4.0.0</code></pre>

<p>Then create a new app:</p>

<pre><code class="term">$ rails new myapp --database=postgresql
$ cd myapp</code></pre>

<p>Rails 4 no longer has a static index page in production. When you’re using a new app, there won’t be a root page in production. We’ll create one then.</p>

<p>In <code>app/controllers/application_controller.rb</code> add the index method in the <code>ApplicationController</code> class:</p>

<pre><code class="ruby">def index
  render text: "Hello World"
end</code></pre>

<p>It should look something like this:</p>

<pre><code class="ruby">class ApplicationController &lt; ActionController::Base
  # Prevent CSRF attacks by raising an exception.
  # For APIs, you may want to use :null_session instead.
  protect_from_forgery with: :exception

  def index
    render text: "Hello World"
  end
end</code></pre>

<p>Now we need to have Rails route to this action. We’ll edit <code>config/routes.rb</code> to set the index page to our new method:</p>

<pre><code class="ruby">Myapp::Application.routes.draw do
  root 'application#index'
end</code></pre>

<h2 id="heroku-gems">Heroku gems</h2>

<p>Heroku integration has previously relied on using the Rails plugin system, which has been removed from Rails 4. To enable features such as static asset serving and logging on Heroku please add the following gems to your <code>Gemfile</code>:</p>

<pre><code class="ruby">gem 'rails_12factor', group: :production</code></pre>

<p>Then run:</p>

<pre><code class="term">$ bundle install</code></pre>

<p>That should be the minimum you need to do to integrate with Heroku. We talk more about Rails integration on our <a href="https://devcenter.heroku.com/articles/ruby-support#injected-plugins">Ruby Support page</a>.</p>

<h2 id="use-postgres">Use Postgres</h2>
<div class="callout">
<p>We highly recommend using PostgreSQL during development. Maintaining <a href="http://www.12factor.net/dev-prod-parity">parity between your development</a> and deployment environments prevents subtle bugs from being introduced because of differences between your environments.</p>
</div>
<p>If you did not specify <code>postgresql</code> while creating your app (using <code>--database=postgresql</code>) you will need to add the <code>pg</code> gem to your Rails project. Edit your <code>Gemfile</code> and change this line:</p>

<pre><code class="ruby">gem 'sqlite3'</code></pre>

<p>To this:</p>

<pre><code class="ruby">gem 'pg'</code></pre>

<p>In addition to using the <code>pg</code> gem, you’ll also need to ensure the <code>config/database.yml</code> is using the <code>postgresql</code> adapter and not <code>sqlite3</code>. You’re <code>config/database.yml</code> file should look something like this:</p>

<pre><code class="ruby">development:
  adapter: postgresql
  encoding: unicode
  database: myapp_development
  pool: 5
  username: myapp
  password:
test:
  adapter: postgresql
  encoding: unicode
  database: myapp_test
  pool: 5
  username: myapp
  password:
production:
  adapter: postgresql
  encoding: unicode
  database: myapp_production
  pool: 5
  username: myapp
  password:</code></pre>

<p>Make sure to update the username and password for your database.</p>

<p>And re-install your dependencies (to generate a new <code>Gemfile.lock</code>):</p>

<pre><code class="term">$ bundle install</code></pre>

<p>You can get more information on why this change is needed and how to configure your app to run postgres locally see <a href="https://devcenter.heroku.com/articles/sqlite3">why you cannot use Sqlite3 on Heroku</a>.</p>

<h2 id="specify-ruby-version-in-app">Specify Ruby version in app</h2>

<p>Rails 4 requires Ruby 1.9.3 or above. Heroku has a recent version of Ruby installed, however you can specify an exact version by using the <code>ruby</code> DSL in your <code>Gemfile</code>. For this guide we’ll be using Ruby 2.0.0 so add this to your <code>Gemfile</code>:</p>

<pre><code class="ruby">ruby "2.0.0"</code></pre>

<p>You should also be running the same version of Ruby locally. You can verify by running <code>$ ruby -v</code>. You can get more information on <a href="https://devcenter.heroku.com/articles/ruby-versions">specifying your Ruby version on Heroku here</a>.</p>

<h2 id="store-your-app-in-git">Store your app in git</h2>

<p>Heroku relies on <a href="http://git-scm.com/">git</a>, a distributed source control managment tool, for deploying your project. If your project is not already in git first verify that <code>git</code> is on your system:</p>

<pre><code class="term">$ git --help
usage: git [--version] [--exec-path[=&lt;path&gt;]] [--html-path] [--man-path] [--info-path]
           [-p|--paginate|--no-pager] [--no-replace-objects] [--bare]
           [--git-dir=&lt;path&gt;] [--work-tree=&lt;path&gt;] [--namespace=&lt;name&gt;]
           [-c name=value] [--help]
           &lt;command&gt; [&lt;args&gt;]
# ...</code></pre>

<p>If you don’t see any output or get <code>command not found</code> you will need to install it on your system, verify that the Heroku toolbelt is installed.</p>

<p>Once you’ve verified that git works, first make sure you are in your Rails app directory. Now run these three commands in your Rails app directory to initialize and commit your code to git:</p>

<pre><code class="term">$ git init
$ git add .
$ git commit -m "init"</code></pre>

<p>Now that your application is committed to git you can deploy to Heroku.</p>

<h2 id="deploy-your-application-to-heroku">Deploy your application to Heroku</h2>

<p>Make sure you are in the directory that contains your Rails app, then create the app on Heroku:</p>

<pre><code class="term">$ heroku create
Creating calm-brook-1268... done, stack is cedar
http://calm-brook-1268.herokuapp.com/ | git@heroku.com:calm-brook-1268.git
Git remote heroku added</code></pre>

<p>Verify that the remote was added to your project by running</p>

<pre><code class="term">$ git config -e</code></pre>

<p>If you do not see <code>fatal: not in a git directory</code> then you are safe to deploy to Heroku. After you deploy you will need to migrate your database, make sure it is properly scaled and use logs to debug any issues that come up.</p>

<p>Deploy your code:</p>

<pre><code class="term">$ git push heroku master
Counting objects: 112, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (77/77), done.
Writing objects: 100% (112/112), 27.01 KiB, done.
Total 112 (delta 20), reused 112 (delta 20)
-----&gt; Ruby/Rails app detected
-----&gt; Using Ruby version: ruby-2.0.0
-----&gt; Installing dependencies using Bundler version 1.3.2
       Running: bundle install --without development:test --path vendor/bundle --binstubs vendor/bundle/bin --deployment
       Fetching gem metadata from https://rubygems.org/..........
       Fetching gem metadata from https://rubygems.org/..
       Installing rake (10.1.0)
       ...
       Installing uglifier (2.2.1)
       Your bundle is complete! It was installed into ./vendor/bundle
       Post-install message from rdoc:
       Depending on your version of ruby, you may need to install ruby rdoc/ri data:
       &lt;= 1.8.6 : unsupported
       = 1.8.7 : gem install rdoc-data; rdoc-data --install
       = 1.9.1 : gem install rdoc-data; rdoc-data --install
       &gt;= 1.9.2 : nothing to do! Yay!
       Cleaning up the bundler cache.
-----&gt; Writing config/database.yml to read from DATABASE_URL
-----&gt; Preparing app for Rails asset pipeline
       Running: rake assets:precompile
       I, [2013-09-11T01:22:58.078536 #1186]  INFO -- : Writing /tmp/build_1013n2ur0ve97/public/assets/application-268d763ee3d9fa5a009263184a8d78b2.js
       I, [2013-09-11T01:22:58.101084 #1186]  INFO -- : Writing /tmp/build_1013n2ur0ve97/public/assets/application-58c7c0e35a67f189e19b8c485930e614.css
       Asset precompilation completed (5.86s)
       Cleaning assets
-----&gt; Discovering process types
       Procfile declares types      -&gt; (none)
       Default types for Ruby/Rails -&gt; console, rake, web, worker

-----&gt; Compiled slug size: 34.8MB
-----&gt; Launching... done, v6
       http://calm-brook-1268.herokuapp.com deployed to Heroku

To git@heroku.com:calm-brook-1268.git
 * [new branch]      master -&gt; master</code></pre>

<h2 id="migrate-your-database">Migrate your database</h2>

<p>If you are using the database in your application you need to manually migrate the database by running:</p>

<pre><code class="term">$ heroku run rake db:migrate</code></pre>

<p>Any commands after the <code>heroku run</code> will be executed on a Heroku <a href="/articles/dynos">dyno</a>.</p>

<h2 id="visit-your-application">Visit your application</h2>

<p>You’ve deployed your code to Heroku. You can now instruct Heroku to execute a process type. Heroku does this by running the associated command in a <a href="/articles/dynos">dyno</a> - a lightweight container which is the basic unit of composition on Heroku.</p>

<p>Let’s ensure we have one dyno running the <code>web</code> process type:</p>

<pre><code class="term">$ heroku ps:scale web=1</code></pre>

<p>You can check the state of the app’s dynos. The <code>heroku ps</code> command lists the running dynos of your application:</p>

<pre><code class="term">$ heroku ps
=== web: `bin/rails server -p $PORT -e $RAILS_ENV`
web.1: up for 5s</code></pre>

<p>Here, one dyno is running.</p>

<p>We can now visit the app in our browser with <code>heroku open</code>.</p>

<pre><code class="term">$ heroku open
Opening calm-brook-1268... done</code></pre>

<p>You should now see the “Hello World” text we inserted above.</p>

<p>Heroku gives you a default web app name for simplicty while you are developing. When you are ready to scale up and use Heroku for production you can add your own <a href="https://devcenter.heroku.com/articles/custom-domains">Custom Domain</a>.</p>

<h2 id="view-the-logs">View the logs</h2>

<p>If you run into any problems getting your app to perform properly, you will first need to check the logs.</p>

<p>Heroku treats logs as streams of time-ordered events aggregated from the output streams of all the dynos running the components of your application. Heroku’s <a href="/articles/logplex">Logplex</a> provides a single channel for all of these events.</p>

<p>You can view information about your running app using one of the <a href="/articles/logging">logging commands</a>, <code>heroku logs</code>:</p>

<pre><code class="term">$ heroku logs
2013-02-26T01:47:32+00:00 heroku[web.1]: State changed from created to starting
2013-02-26T01:47:33+00:00 heroku[web.1]: Starting process with command `rails server -p 16142 -e $RAILS_ENV`
2013-02-26T01:47:35+00:00 app[web.1]: [2013-02-26 01:47:35] INFO  WEBrick 1.3.1
2013-02-26T01:47:35+00:00 app[web.1]: [2013-02-26 01:47:35] INFO  WEBrick::HTTPServer#start: pid=2 port=16142
2013-02-26T01:47:35+00:00 app[web.1]: [2013-02-26 01:47:35] INFO  ruby 2.0.0 (2013-02-24) [x86_64-linux]
2013-02-26T01:47:36+00:00 heroku[web.1]: State changed from starting to up</code></pre>

<p>You can also get the full stream of logs by running the logs command with the <code>--tail</code> flag like this:</p>

<pre><code class="term">$ heroku logs --tail</code></pre>

<h2 id="dyno-sleeping-and-scaling">Dyno sleeping and scaling</h2>

<p>Having only a single web dyno running will result in the dyno <a href="/articles/dynos#dyno-sleeping">going to sleep</a> after one hour of inactivity. This causes a delay of a few seconds for the first request upon waking. Subsequent requests will perform normally.</p>

<p>To avoid this, you can scale to more than one web dyno. For example:</p>

<pre><code class="term">$ heroku ps:scale web=2</code></pre>

<p>For each application, Heroku provides <a href="/articles/usage-and-billing#750-free-dyno-hours-per-app">750 free dyno-hours</a>. Running your app at 2 dynos would exceed this free, monthly allowance, so let’s scale back:</p>

<pre><code class="term">$ heroku ps:scale web=1</code></pre>

<h2 id="console">Console</h2>

<p>Heroku allows you to run commands in a <a href="/articles/oneoff-admin-ps">one-off dyno</a> - scripts and applications that only need to be executed when needed - using the <code>heroku run</code> command. Use this to launch a Rails console process attached to your local terminal for experimenting in your app’s environment:</p>

<pre><code class="term">$ heroku run rails console
Running `rails console` attached to terminal... up, run.2591
Loading production environment (Rails 4.0.0)
irb(main):001:0&gt;</code></pre>

<h2 id="rake">Rake</h2>

<p>Rake can be run as an attached process exactly like the console:</p>

<pre><code class="term">$ heroku run rake db:migrate</code></pre>

<h2 id="webserver">Webserver</h2>

<p>By default, your app’s web process runs <code>rails server</code>, which uses Webrick. This is fine for testing, but for production apps you’ll want to switch to a more robust webserver. On Cedar, <a href="/articles/ruby-production-web-server">we recommend Unicorn as the webserver</a>. Regardless of the webserver you choose, production apps should always specify the webserver explicitly in the <code>Procfile</code>.</p>

<p>First, add Unicorn to your application <code>Gemfile</code>:</p>

<pre><code>gem 'unicorn'</code></pre>

<p>Run <code>$ bundle install</code>, now you are ready to configure your app to use Unicorn.</p>

<p>Create a configuration file for Unicorn at <code>config/unicorn.rb</code>:</p>

<pre><code>$ touch config/unicorn.rb</code></pre>

<p>Now we’re going to add Unicorn specific configuration options, that we explain in detail in <a href="https://devcenter.heroku.com/articles/rails-unicorn">Heroku’s Unicorn documentation</a>:</p>

<pre><code># config/unicorn.rb
worker_processes 3
timeout 30
preload_app true

before_fork do |server, worker|

  Signal.trap 'TERM' do
    puts 'Unicorn master intercepting TERM and sending myself QUIT instead'
    Process.kill 'QUIT', Process.pid
  end

  defined?(ActiveRecord::Base) and
    ActiveRecord::Base.connection.disconnect!
end

after_fork do |server, worker|

  Signal.trap 'TERM' do
    puts 'Unicorn worker intercepting TERM and doing nothing. Wait for master to sent QUIT'
  end

  defined?(ActiveRecord::Base) and
    ActiveRecord::Base.establish_connection
end</code></pre>

<p>This default configuration assumes a standard Rails app with Active Record. You should get acquainted with the different options in <a href="http://unicorn.bogomips.org/Unicorn/Configurator.html">the official Unicorn documentation</a>.</p>

<p>Finally you will need to tell Heroku how to run your Rails app by creating a <code>Procfile</code> in the root of your application directory.</p>

<h3 id="procfile">Procfile</h3>

<p>Change the command used to launch your web process by creating a file called <a href="/articles/procfile">Procfile</a> and entering this:</p>

<pre><code>web: bundle exec unicorn -p $PORT -c ./config/unicorn.rb</code></pre>

<p>Note: The case of <code>Procfile</code> is sensitive, the first letter must be uppercase.</p>

<p>Set the <code>RACK_ENV</code> to development in your environment and a <code>PORT</code> to connect to. Before pushing to Heroku you’ll want to test with the <code>RACK_ENV</code> set to production since this is the enviroment your Heroku app will run in.</p>

<pre><code class="term">$ echo "RACK_ENV=development" &gt;&gt;.env
$ echo "PORT=5000" &gt;&gt; .env</code></pre>

<p>You’ll also want to add <code>.env</code> to your <code>.gitignore</code> since this is for local enviroment setup.</p>

<pre><code class="term">$ echo ".env" &gt;&gt; .gitignore
$ git add .gitignore
$ git commit -m "add .env to .gitignore"</code></pre>

<p>Test your Procfile locally using Foreman:</p>

<pre><code class="term">$ foreman start
18:24:56 web.1  | I, [2013-03-13T18:24:56.885046 #18793]  INFO -- : listening on addr=0.0.0.0:5000 fd=7
18:24:56 web.1  | I, [2013-03-13T18:24:56.885140 #18793]  INFO -- : worker=0 spawning...
18:24:56 web.1  | I, [2013-03-13T18:24:56.885680 #18793]  INFO -- : master process ready
18:24:56 web.1  | I, [2013-03-13T18:24:56.886145 #18795]  INFO -- : worker=0 spawned pid=18795
18:24:56 web.1  | I, [2013-03-13T18:24:56.886272 #18795]  INFO -- : Refreshing Gem list
18:24:57 web.1  | I, [2013-03-13T18:24:57.647574 #18795]  INFO -- : worker=0 ready</code></pre>

<p>Looks good, so press Ctrl-C to exit. Deploy your changes to Heroku:</p>

<pre><code class="term">$ git add .
$ git commit -m "use unicorn via procfile"
$ git push heroku</code></pre>

<p>Check <code>ps</code>, you’ll see the web process uses your new command specifying Unicorn as the web server</p>

<pre><code class="term">$ heroku ps
Process State Command
------------ ------------------ ------------------------------
web.1 starting for 3s unicorn -p $..</code></pre>

<p>The logs also reflect that we are now using Unicorn:</p>

<pre><code class="term">$ heroku logs
2013-03-14T01:57:55+00:00 heroku[web.1]: State changed from up to starting
2013-03-14T01:57:59+00:00 heroku[web.1]: Starting process with command `unicorn -p 26253 -E $RACK_ENV`
2013-03-14T01:58:00+00:00 app[web.1]: =&gt; Rails 4.0.0 application starting in production on http://0.0.0.0:27993
2013-03-14T01:58:00+00:00 app[web.1]: I, [2013-03-14T01:58:00.253906 #2]  INFO -- : listening on addr=0.0.0.0:26253 fd=7
2013-03-14T01:58:00+00:00 app[web.1]: I, [2013-03-14T01:58:00.254256 #2]  INFO -- : worker=0 spawning...
2013-03-14T01:58:00+00:00 app[web.1]: I, [2013-03-14T01:58:00.257455 #2]  INFO -- : master process ready
2013-03-14T01:58:00+00:00 app[web.1]: I, [2013-03-14T01:58:00.258541 #4]  INFO -- : Refreshing Gem list
2013-03-14T01:58:00+00:00 app[web.1]: I, [2013-03-14T01:58:00.258293 #4]  INFO -- : worker=0 spawned pid=4
2013-03-14T01:58:01+00:00 app[web.1]: I, [2013-03-14T01:58:01.347337 #4]  INFO -- : worker=0 ready
2013-03-14T01:58:01+00:00 heroku[web.1]: State changed from starting to up</code></pre>

<h2 id="rails-asset-pipeline">Rails Asset Pipeline</h2>

<p>There are several options for invoking the <a href="http://guides.rubyonrails.org/asset_pipeline.html">Rails asset pipeline</a> when deploying to Heroku. For generalinformation on the asset pipeline please see the <a href="/articles/rails3x-asset-pipeline-cedar">Rails 3.1+ Asset Pipeline on Heroku Cedar</a> article.</p>

<p>The <code>config.assets.initialize_on_precompile</code> option has been removed and not needed for Rails 4. Also, any failure in asset compilation will now cause the push to fail. For Rails 4 asset pipeline support see the <a href="https://devcenter.heroku.com/articles/ruby-support#rails-4-x-applications">Ruby Support</a> page.</p>

<h2 id="troubleshooting">Troubleshooting</h2>

<p>If you push up your app and it crashes (<code>heroku ps</code> shows state <code>crashed</code>), check your logs to find out what went wrong. Here are some common problems.</p>

<h3 id="runtime-dependencies-on-development-test-gems">Runtime dependencies on development/test gems</h3>

<p>If you’re missing a gem when you deploy, check your Bundler groups. Heroku builds your app without the <code>development</code> or <code>test</code> groups, and if you app depends on a gem from one of these groups to run, you should move it out of the group.</p>

<p>One common example using the RSpec tasks in your <code>Rakefile</code>. If you see this in your Heroku deploy:</p>

<pre><code class="term">$ heroku run rake -T
Running `bundle exec rake -T` attached to terminal... up, ps.3
rake aborted!
no such file to load -- rspec/core/rake_task</code></pre>

<p>Then you’ve hit this problem. First, duplicate the problem locally:</p>

<pre><code class="term">$ bundle install --without development:test
…
$ bundle exec rake -T
rake aborted!
no such file to load -- rspec/core/rake_task</code></pre>

<p>Now you can fix it by making these Rake tasks conditional on the gem load. For example:</p>

<h3 id="rakefile">Rakefile</h3>

<pre><code class="ruby">begin
  require "rspec/core/rake_task"

  desc "Run all examples"

  RSpec::Core::RakeTask.new(:spec) do |t|
    t.rspec_opts = %w[--color]
    t.pattern = 'spec/**/*_spec.rb'
  end
rescue LoadError
end</code></pre>

<p>Confirm it works locally, then push to Heroku.</p>